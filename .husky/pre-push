#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# –ó–∞—â–∏—Ç–∞ –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
if [ -n "$SKIP_PRE_PUSH" ]; then
  exit 0
fi

echo "üöÄ PRE-PUSH: Running checks and auto-fixes before push..."

echo "üßπ Running Prettier (format)..."
npm run precommit:format

echo "üîß Running ESLint autofix..."
npm run precommit:lint

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
CHANGED_FILES=$(git diff --name-only)
if [ -n "$CHANGED_FILES" ]; then
  echo "‚úÖ Code was auto-fixed. Staging changes..."
  git add -A
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ –∫–æ–º–º–∏—Ç–∏—Ç—å
  if [ -n "$(git diff --cached --name-only)" ]; then
    echo "üíæ Committing auto-fixes..."
    git commit -m "chore: auto-fix formatting and linting issues [skip ci]"
    
    echo "üîç Running ESLint strict check on fixed code..."
    if ! npm run lint:strict; then
      echo ""
      echo "‚ùå ESLint still found errors or warnings after auto-fix."
      echo "üí° Please fix remaining issues manually, then commit and push again."
      echo ""
      exit 1
    fi
    
    echo ""
    echo "‚úÖ Auto-fixes committed successfully!"
    echo "üöÄ Pushing auto-fixes along with your changes..."
    
    # –î–µ–ª–∞–µ–º push —Å —Ñ–ª–∞–≥–æ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–∏
    export SKIP_PRE_PUSH=1
    git push "$@" || {
      echo ""
      echo "‚ùå Push failed. Please resolve conflicts and push manually."
      exit 1
    }
    
    echo "‚úÖ All changes pushed successfully!"
    exit 0
  fi
fi

echo "üîç Running ESLint strict check (no warnings allowed)..."
if ! npm run lint:strict; then
  echo ""
  echo "‚ùå ESLint found errors or warnings."
  echo "üí° Run 'npm run lint:fix' to auto-fix issues, then commit and push again."
  echo ""
  exit 1
fi

echo "‚úÖ All checks passed! Pushing..."
exit 0
