#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°
if [ -n "$SKIP_PRE_PUSH" ]; then
  exit 0
fi

echo "ğŸš€ PRE-PUSH: Running checks and auto-fixes before push..."

echo "ğŸ§¹ Running Prettier (format)..."
npm run precommit:format

echo "ğŸ”§ Running ESLint autofix..."
npm run precommit:lint

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ±Ñ‹Ğ»Ğ¸ Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ»Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ/Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
CHANGED_FILES=$(git diff --name-only)
if [ -n "$CHANGED_FILES" ]; then
  echo "âœ… Code was auto-fixed. Staging changes..."
  git add -A
  
  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ñ‚ÑŒ
  if [ -n "$(git diff --cached --name-only)" ]; then
    echo "ğŸ’¾ Committing auto-fixes..."
    git commit -m "chore: auto-fix formatting and linting issues [skip ci]"
    
    echo "ğŸ” Running ESLint strict check on fixed code..."
    if ! npm run lint:strict; then
      echo ""
      echo "âŒ ESLint still found errors or warnings after auto-fix."
      echo "ğŸ’¡ Please fix remaining issues manually, then commit and push again."
      echo ""
      exit 1
    fi
    
    echo ""
    echo "âœ… Auto-fixes committed successfully!"
    echo "ğŸ“ Please run 'git push' again to push the fixes along with your changes."
    echo ""
    exit 1
  fi
fi

echo "ğŸ” Running ESLint strict check (no warnings allowed)..."
if ! npm run lint:strict; then
  echo ""
  echo "âŒ ESLint found errors or warnings."
  echo "ğŸ’¡ Run 'npm run lint:fix' to auto-fix issues, then commit and push again."
  echo ""
  exit 1
fi

echo "âœ… All checks passed! Pushing..."
exit 0
