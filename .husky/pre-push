#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°
if [ -n "$SKIP_PRE_PUSH" ]; then
  exit 0
fi

echo "ğŸ” PRE-PUSH: Running essential CI/CD checks..."
echo ""

# 1. TypeScript type checking
echo "ğŸ“˜ TypeScript type check..."
if ! pnpm run typecheck; then
  echo ""
  echo "âŒ TypeScript type check failed."
  echo "ğŸ’¡ Fix type errors before pushing."
  echo ""
  exit 1
fi
echo "âœ… TypeScript check passed"
echo ""

# 2. Prettier format check
echo "ğŸ’… Prettier format check..."
if ! pnpm run format:check; then
  echo ""
  echo "âŒ Prettier found formatting issues."
  echo "ğŸ’¡ Run 'pnpm lint:fix' to auto-fix formatting, then commit and push again."
  echo ""
  exit 1
fi
echo "âœ… Prettier check passed"
echo ""

# 3. ESLint strict check
echo "ğŸ” ESLint strict check (no warnings allowed)..."
if ! pnpm run lint:strict; then
  echo ""
  echo "âŒ ESLint found errors or warnings."
  echo "ğŸ’¡ Run 'pnpm lint:fix' to auto-fix issues, then commit and push again."
  echo ""
  exit 1
fi
echo "âœ… ESLint check passed"
echo ""

# 4. Build check (ensure code compiles)
echo "ğŸ—ï¸  Build check..."
if ! pnpm run build; then
  echo ""
  echo "âŒ Build failed."
  echo "ğŸ’¡ Fix build errors before pushing."
  echo ""
  exit 1
fi
echo "âœ… Build check passed"
echo ""

# 5. Unit tests (catch errors like missing jest-axe)
echo "ğŸ§ª Running unit tests..."
if ! pnpm test; then
  echo ""
  echo "âŒ Unit tests failed."
  echo "ğŸ’¡ Fix failing tests before pushing."
  echo ""
  exit 1
fi
echo "âœ… Unit tests passed"
echo ""

echo "âœ… All checks passed! Pushing..."
exit 0
