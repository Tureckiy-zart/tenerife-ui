name: Test NPM Token

on:
  workflow_dispatch: # Manual trigger only
  push:
    branches: ["main"]
    paths:
      - ".github/workflows/test-npm-token.yml" # Only run when this file changes

jobs:
  test-npm-token:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/
          scope: "@tenerife.music"

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify NPM_TOKEN exists
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "❌ ERROR: NPM_TOKEN secret is not set in GitHub Secrets"
            echo "Please add NPM_TOKEN to: Settings → Secrets and variables → Actions"
            exit 1
          else
            echo "✅ NPM_TOKEN secret is configured"
            echo "Token prefix: ${NPM_TOKEN:0:10}..."
          fi

      - name: Setup NPM token
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Configuring npm authentication..."
          npm config set //registry.npmjs.org/:_authToken=${NPM_TOKEN}
          echo "@tenerife.music:registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Test npm authentication (dry-run)
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Testing npm authentication with dry-run publish..."

          # Verify token format
          if [[ ! "$NPM_TOKEN" =~ ^npm_ ]]; then
            echo "❌ ERROR: NPM_TOKEN format is incorrect"
            echo "Token should start with 'npm_'"
            echo "Current token starts with: ${NPM_TOKEN:0:10}..."
            exit 1
          fi

          # Test authentication using dry-run publish (works with granular tokens)
          # Granular tokens don't support npm whoami, so we use publish --dry-run instead
          if npm publish --dry-run --access public; then
            echo "✅ Successfully authenticated! Token is valid."
          else
            echo "❌ ERROR: npm authentication failed"
            echo "Possible issues:"
            echo "  - Token is invalid or expired"
            echo "  - Token doesn't have correct permissions for @tenerife.music scope"
            echo "  - Token doesn't have publish permissions"
            exit 1
          fi

      - name: Verify package name
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "Package name: $PACKAGE_NAME"

          # Check if package exists
          if npm info "$PACKAGE_NAME" > /dev/null 2>&1; then
            echo "✅ Package exists on npm"
            npm info "$PACKAGE_NAME" --json | jq -r '.version // "unknown"'
          else
            echo "ℹ️  Package doesn't exist yet (normal for first release)"
          fi

      - name: Test semantic-release dry-run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Running semantic-release dry-run..."
          npx semantic-release --dry-run || echo "⚠️  Dry-run completed (may show warnings if no commits to release)"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ NPM Token Verification Complete"
          echo ""
          echo "All checks passed! Your NPM_TOKEN is configured correctly."
          echo ""
          echo "Next steps:"
          echo "  1. Make a conventional commit (e.g., 'feat: add feature')"
          echo "  2. Push to main branch"
          echo "  3. Monitor release workflow in Actions tab"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
